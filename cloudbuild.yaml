steps:
  # Temporarily disable kaniko cache approache.
  # build docker image for target sub-pacakge
  # use debug tag so that we can use `sh` entrypoint
  #- name: 'gcr.io/kaniko-project/executor:debug'
  #  id: Build Image
  #  entrypoint: 'sh'
  #  args:
  #    - '-c'
  #    - |
  #      cp yarn.lock packages/$_TARGET_PACKAGE
  #      cd packages/$_TARGET_PACKAGE
  #      /kaniko/executor --context="$(pwd)" --cache=true --cache-ttl=6h --destination=gcr.io/$PROJECT_ID/$_IMAGE_NAME:${BRANCH_NAME}_${SHORT_SHA}

  # Pull previous image
  - name: gcr.io/cloud-builders/docker
    args:
      - '-c'
      - 'docker pull gcr.io/$PROJECT_ID/$_IMAGE_NAME:latest || exit 0'
    entrypoint: bash

  # Build image
  - name: gcr.io/cloud-builders/docker
    env:
    - 'NEXT_PUBLIC_ENV=${BRANCH_NAME}'
    args:
      - '-c'
      - >
        cp yarn.lock packages/$_TARGET_PACKAGE
        cd packages/$_TARGET_PACKAGE
        printenv > .env.local
        docker build -t \
        gcr.io/$PROJECT_ID/$_IMAGE_NAME:${BRANCH_NAME}_${SHORT_SHA} \
        -t gcr.io/$PROJECT_ID/$_IMAGE_NAME:latest \
        --cache-from gcr.io/$PROJECT_ID/$_IMAGE_NAME:latest .
    entrypoint: bash

  # Push container image to registry
  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - 'gcr.io/$PROJECT_ID/$_IMAGE_NAME:${BRANCH_NAME}_${SHORT_SHA}'

  # Deploy container image to dev Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - '$_CLOUD_RUN_SERVICE_NAME'
      - '--image'
      - 'gcr.io/$PROJECT_ID/${_IMAGE_NAME}:${BRANCH_NAME}_${SHORT_SHA}'
      - '--region'
      - 'asia-east1'

  # Push container image to registry to update the latest one
  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - 'gcr.io/$PROJECT_ID/$_IMAGE_NAME:latest'

timeout: 1200s

images: ['gcr.io/$PROJECT_ID/$_IMAGE_NAME:${BRANCH_NAME}_${SHORT_SHA}', 'gcr.io/$PROJECT_ID/$_IMAGE_NAME:latest']

substitutions:
  _TARGET_PACKAGE: '' # default value
  _IMAGE_NAME: '' # default value
  _CLOUD_RUN_SERVICE_NAME: '' # default value
